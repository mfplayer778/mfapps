<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æˆåŠŸç‡ç®—å‡ºå›â…¡ï¼ˆéŸ³ä»˜ãï¼‹CSVï¼‰</title>

<style>
body{
  font-family: system-ui, -apple-system;
  background:#1e1e2f;
  color:#fff;
  margin:0;
  padding:12px;
}
h1{text-align:center;margin-bottom:10px;font-size:20px}

/* ===== ã‚°ãƒªãƒƒãƒ‰ ===== */
.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
.box{
  border:2px solid #fff;
  border-radius:10px;
  padding:8px;
}
.box h2{text-align:center;margin:0 0 6px;font-size:16px}
.buttons{
  display:flex;
  flex-direction:column;
  gap:6px;
  margin-bottom:6px;
}
button{
  border:none;
  border-radius:8px;
  font-weight:bold;
  color:#000;
}
.success,.miss{
  height:42px;
  font-size:15px;
}
.success{background:#ff9933}
.miss{background:#66ccff}
.reset{background:#ff6666;height:46px;font-size:16px;flex-grow:1;}
.csv{
  background:#b399ff;
  width:100%;
  height:44px;
  font-size:15px;
  border-radius:10px;
  margin-top:10px; /* ã“ã“ã§ä¸Šã«ä½™ç™½è¿½åŠ  */
}
.soundToggle{
  background:#66dd88;
  height:46px;
  font-size:14px;
  border-radius:8px;
  width:90px;
}

.footer{text-align:center}
.value{font-size:14px}
.rate{font-size:22px;font-weight:bold}
.ci{font-size:13px;color:#ffeeaa}

.totalBox{
  margin-top:10px;
  border:2px solid #fff;
  border-radius:10px;
  padding:8px;
  text-align:center;
  background:#2b2b44;
}
.totalRate{font-size:26px;font-weight:bold}
.totalCI{font-size:14px;color:#ffeeaa}

.memoSection{
  margin-top:10px;
  border:2px solid #fff;
  border-radius:10px;
  padding:6px;
}
textarea{
  width:100%;
  height:70px;
  background:#1e1e2f;
  color:#fff;
  border:none;
  resize:vertical;
  padding:6px;
  box-sizing:border-box;
}

/* ãƒªã‚»ãƒƒãƒˆï¼‹éŸ³ON/OFF æ¨ªä¸¦ã³ */
.resetSoundWrapper{
  display:flex;
  gap:6px;
  margin-top:10px;
  flex-wrap:nowrap;
  align-items:center;
}
@media (max-width:400px){
  .success,.miss,.reset,.csv,.soundToggle{height:42px;font-size:14px}
  .rate{font-size:20px}
  .ci{font-size:12px}
}
</style>
</head>

<body>
<h1>æˆåŠŸç‡ç®—å‡ºå›â…¡</h1>

<div class="grid" id="grid"></div>

<div class="totalBox">
  <div>ABCD åˆè¨ˆæˆåŠŸç‡</div>
  <div class="value">æˆåŠŸ: <span id="totalSuccess">0</span> / ãƒŸã‚¹: <span id="totalMiss">0</span></div>
  <div class="totalRate" id="totalRate">0.0%</div>
  <div class="totalCI" id="totalCI">0.0 - 0.0%</div>
</div>

<div class="memoSection">
  <textarea id="memo" placeholder="ãƒ¡ãƒ¢æ¬„"></textarea>
</div>

<div class="resetSoundWrapper">
  <button class="reset" onclick="resetAll()">å…¨ãƒªã‚»ãƒƒãƒˆ</button>
  <button class="soundToggle" onclick="toggleSound()">ğŸ”Š éŸ³ON</button>
</div>

<!-- CSVãƒœã‚¿ãƒ³ã«ä½™ç™½ãŒã¤ã„ãŸ -->
<button class="csv" onclick="exportCSV()">CSVå‡ºåŠ›</button>

<script>
// ==== éŸ³é–¢ä¿‚ ====
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let soundOn = true;
function playTone(freq,duration=0.1,volume=0.25){
  if(!soundOn) return;
  const osc=audioCtx.createOscillator();
  const gain=audioCtx.createGain();
  osc.frequency.value=freq;
  gain.gain.value=volume;
  osc.connect(gain); gain.connect(audioCtx.destination);
  osc.start(); osc.stop(audioCtx.currentTime+duration);
}
function playSuccessSound(){playTone(880,0.12,0.3);}
function playMinusSound(){playTone(440,0.12,0.25);}
function toggleSound(){
  soundOn=!soundOn;
  document.querySelector(".soundToggle").textContent = soundOn?"ğŸ”Š éŸ³ON":"ğŸ”‡ éŸ³OFF";
}

// ==== ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ– ====
const labels=["A","B","C","D"];
const data={};
const grid=document.getElementById("grid");

labels.forEach(l=>{
  data[l]={s:0,m:0};
  const box=document.createElement("div");
  box.className="box";
  box.innerHTML=`
    <h2>${l}</h2>
    <div class="buttons">
      <button class="success" onclick="add('${l}',true)">æˆåŠŸ</button>
      <button class="miss" onclick="add('${l}',false)">ãƒŸã‚¹</button>
    </div>
    <div class="footer">
      <div class="value">æˆåŠŸ:0 / ãƒŸã‚¹:0</div>
      <div class="rate">0.0%</div>
      <div class="ci">0.0 - 0.0%</div>
    </div>
  `;
  grid.appendChild(box);
  data[l].el=box;
});

// ==== ãƒ‡ãƒ¼ã‚¿æ“ä½œ ====
function add(l,isS){
  if(isS){ data[l].s++; playSuccessSound(); }
  else{ data[l].m++; playMinusSound(); }
  update(l); updateTotal();
}

function update(l){
  const d=data[l], t=d.s+d.m;
  const rate=t?((d.s/t)*100).toFixed(1):"0.0";
  let ci="0.0 - 0.0";
  if(t){
    const p=d.s/t, se=Math.sqrt(p*(1-p)/t);
    ci=`${Math.max(0,(p-1.96*se)*100).toFixed(1)} - ${Math.min(100,(p+1.96*se)*100).toFixed(1)}`;
  }
  const f=d.el.querySelector(".footer");
  f.children[0].textContent=`æˆåŠŸ:${d.s} / ãƒŸã‚¹:${d.m}`;
  f.children[1].textContent=`${rate}%`;
  f.children[2].textContent=`${ci}%`;
}

function updateTotal(){
  let s=0,m=0;
  labels.forEach(l=>{s+=data[l].s; m+=data[l].m;});
  const t=s+m;
  document.getElementById("totalSuccess").textContent=s;
  document.getElementById("totalMiss").textContent=m;
  const rate=t?((s/t)*100).toFixed(1):"0.0";
  document.getElementById("totalRate").textContent=`${rate}%`;

  let ci="0.0 - 0.0";
  if(t){
    const p=s/t, se=Math.sqrt(p*(1-p)/t);
    ci=`${Math.max(0,(p-1.96*se)*100).toFixed(1)} - ${Math.min(100,(p+1.96*se)*100).toFixed(1)}`;
  }
  document.getElementById("totalCI").textContent=`${ci}%`;
}

// ==== CSVå‡ºåŠ› ====
function exportCSV(){
  let csv="åŒºåˆ†,æˆåŠŸ,ãƒŸã‚¹,æˆåŠŸç‡(%)\n";
  labels.forEach(l=>{
    const d=data[l], t=d.s+d.m;
    const r=t?((d.s/t)*100).toFixed(1):"0.0";
    csv+=`${l},${d.s},${d.m},${r}\n`;
  });
  let ts=0,tm=0;
  labels.forEach(l=>{ts+=data[l].s; tm+=data[l].m;});
  const tt=ts+tm;
  const tr=tt?((ts/tt)*100).toFixed(1):"0.0";
  csv+=`åˆè¨ˆ,${ts},${tm},${tr}\n\n`;
  csv+=`ãƒ¡ãƒ¢,"${document.getElementById("memo").value.replace(/"/g,'""')}"\n`;
  csv+=`å‡ºåŠ›æ—¥æ™‚,${new Date().toLocaleString()}\n`;

  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="æˆåŠŸç‡ç®—å‡ºçµæœ.csv";
  a.click();
}

// ==== ãƒªã‚»ãƒƒãƒˆ ====
function resetAll(){
  labels.forEach(l=>{data[l].s=0; data[l].m=0; update(l);});
  updateTotal();
  document.getElementById("memo").value="";
}
</script>
</body>
</html>
