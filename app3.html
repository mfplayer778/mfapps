<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æˆåŠŸç‡ç®—å‡ºå›â…¡ï¼ˆã‚¹ãƒãƒ›å¯¾å¿œï¼‰</title>
<style>
body{
  font-family: system-ui, -apple-system;
  background:#1e1e2f;
  color:#fff;
  margin:0;
  padding:12px;
}
h1{text-align:center;margin-bottom:10px;font-size:20px}

.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}

.box{
  border:2px solid #fff;
  border-radius:10px;
  padding:8px;
}

.box h2{text-align:center;margin:0 0 6px;font-size:16px}

.buttons{
  display:flex;
  flex-direction:column;
  gap:6px;
  margin-bottom:6px;
}

button{
  border:none;
  border-radius:8px;
  font-weight:bold;
  color:#000;
}

.success,.miss{
  height:50px;
  font-size:16px;
  width:100%;
}
.success{background:#ff9933}
.miss{background:#66ccff}

.totalBox{
  margin-top:10px;
  border:2px solid #fff;
  border-radius:10px;
  padding:8px;
  text-align:center;
  background:#2b2b44;
}

.totalRate{font-size:26px;font-weight:bold}
.totalCI{font-size:14px;color:#ffeeaa}
.totalCount{font-size:16px;margin-top:4px}

.memoSection{
  margin-top:10px;
  border:2px solid #fff;
  border-radius:10px;
  padding:6px;
  margin-bottom:12px; /* ã“ã“ã§ä¸‹ã®ä½™ç™½ã‚’è¿½åŠ  */
}

textarea{
  width:100%;
  height:70px;
  background:#1e1e2f;
  color:#fff;
  border:none;
  resize:vertical;
  padding:6px;
  box-sizing:border-box;
}

.resetSoundWrapper{
  display:flex;
  gap:8px;
  margin-bottom:6px;
  flex-wrap:wrap;
  align-items:center;
}

.csvWrapper{
  margin-bottom:10px;
}

.reset{background:#ff6666; height:46px; font-size:16px; flex-grow:1;}
.soundToggle{background:#66dd88; height:46px; font-size:14px; width:90px;}
.csv{background:#cdaeff; height:44px; font-size:15px; width:100%; border-radius:8px;}

button:active{opacity:0.7}

.footer{text-align:center;margin-top:10px}
.value{font-size:14px;margin:3px 0}
.rate{font-size:22px;font-weight:bold;margin-top:4px}
.ci{font-size:13px;color:#ffeeaa}

@media (max-width: 400px){
  .success,.miss,.reset,.csv,.soundToggle{height:50px;font-size:16px}
  .rate{font-size:24px}
  .ci{font-size:13px}
}
</style>
</head>

<body>
<h1>æˆåŠŸç‡ç®—å‡ºå›â…¡ï¼ˆã‚¹ãƒãƒ›å¯¾å¿œï¼‰</h1>

<div class="grid" id="grid"></div>

<div class="totalBox">
  <div>ABCD åˆè¨ˆæˆåŠŸç‡</div>
  <div class="totalRate" id="totalRate">0.0%</div>
  <div class="totalCount" id="totalCount">æˆåŠŸ:0 / ãƒŸã‚¹:0</div>
  <div class="totalCI" id="totalCI">0.0 - 0.0%</div>
</div>

<div class="memoSection">
  <textarea id="memo" placeholder="ãƒ¡ãƒ¢æ¬„"></textarea>
</div>

<div class="resetSoundWrapper">
  <button class="reset" onclick="resetAll()">å…¨ãƒªã‚»ãƒƒãƒˆ</button>
  <button class="soundToggle" onclick="toggleSound()">ğŸ”Š éŸ³ON</button>
</div>

<div class="csvWrapper">
  <button class="csv" onclick="exportCSV()">CSVå‡ºåŠ›</button>
</div>

<script>
const labels=["A","B","C","D"];
const data={};
const grid=document.getElementById("grid");

labels.forEach(l=>{
  data[l]={s:0,m:0};
  const box=document.createElement("div");
  box.className="box";
  box.innerHTML=`
    <h2>${l}</h2>
    <div class="buttons">
      <button class="success" onclick="add('${l}',true)">æˆåŠŸ</button>
      <button class="miss" onclick="add('${l}',false)">ãƒŸã‚¹</button>
    </div>
    <div class="footer">
      <div class="value">æˆåŠŸ:0 / ãƒŸã‚¹:0</div>
      <div class="rate">0.0%</div>
      <div class="ci">0.0 - 0.0%</div>
    </div>
  `;
  grid.appendChild(box);
  data[l].el=box;
});

const audioCtx=new (window.AudioContext||window.webkitAudioContext)();
let soundOn=true;
function playTone(freq,duration=0.1,volume=0.25){if(!soundOn)return; const osc=audioCtx.createOscillator(); const gain=audioCtx.createGain(); osc.frequency.value=freq; gain.gain.value=volume; osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime+duration);}
function playSuccessSound(){playTone(880,0.12,0.3);}
function playMinusSound(){playTone(440,0.12,0.25);}
function toggleSound(){soundOn=!soundOn; document.querySelector(".soundToggle").textContent=soundOn?"ğŸ”Š éŸ³ON":"ğŸ”‡ éŸ³OFF";}

function add(l,isS){
  if(isS){ data[l].s++; playSuccessSound(); }else{ data[l].m++; playMinusSound(); }
  update(l);
  updateTotal();
}

function update(l){
  const d=data[l], t=d.s+d.m;
  const rate=t?((d.s/t)*100).toFixed(1):"0.0";
  let ci="0.0 - 0.0";
  if(t){
    const p=d.s/t, se=Math.sqrt(p*(1-p)/t);
    ci=`${Math.max(0,(p-1.96*se)*100).toFixed(1)} - ${Math.min(100,(p+1.96*se)*100).toFixed(1)}`;
  }
  const f=d.el.querySelector(".footer");
  f.children[0].textContent=`æˆåŠŸ:${d.s} / ãƒŸã‚¹:${d.m}`;
  f.children[1].textContent=`${rate}%`;
  f.children[2].textContent=`${ci}%`;
}

function updateTotal(){
  let s=0,m=0;
  labels.forEach(l=>{s+=data[l].s; m+=data[l].m;});
  const t=s+m;
  const rate=t?((s/t)*100).toFixed(1):"0.0";
  document.getElementById("totalRate").textContent=`${rate}%`;
  document.getElementById("totalCount").textContent=`æˆåŠŸ:${s} / ãƒŸã‚¹:${m}`;

  let ci="0.0 - 0.0";
  if(t){
    const p=s/t, se=Math.sqrt(p*(1-p)/t);
    ci=`${Math.max(0,(p-1.96*se)*100).toFixed(1)} - ${Math.min(100,(p+1.96*se)*100).toFixed(1)}`;
  }
  document.getElementById("totalCI").textContent=`${ci}%`;
}

function resetAll(){
  labels.forEach(l=>{data[l].s=0; data[l].m=0; update(l);});
  updateTotal();
  document.getElementById("memo").value="";
  playMinusSound();
}

function exportCSV(){
  let csv="åŒºåˆ†,æˆåŠŸ,ãƒŸã‚¹,æˆåŠŸç‡(%)\n";
  labels.forEach(l=>{
    const d=data[l], t=d.s+d.m;
    const r=t?((d.s/t)*100).toFixed(1):"0.0";
    csv+=`${l},${d.s},${d.m},${r}\n`;
  });
  let ts=0,tm=0;
  labels.forEach(l=>{ts+=data[l].s; tm+=data[l].m;});
  const tt=ts+tm;
  const tr=tt?((ts/tt)*100).toFixed(1):"0.0";
  csv+=`åˆè¨ˆ,${ts},${tm},${tr}\n\n`;
  csv+=`ãƒ¡ãƒ¢,"${document.getElementById("memo").value.replace(/"/g,'""')}"\n`;
  csv+=`å‡ºåŠ›æ—¥æ™‚,${new Date().toLocaleString()}\n`;
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="æˆåŠŸç‡ç®—å‡ºçµæœ.csv";
  a.click();
}
</script>
</body>
</html>
